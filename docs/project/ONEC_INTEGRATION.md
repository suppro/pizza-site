# Интеграция с системой 1С

## Описание

Система поддерживает автоматическую выгрузку заказов в систему 1С. Интеграция реализована через REST API и может работать как автоматически, так и вручную.

## Текущая реализация

### 1. База данных
- Поле `is_synced_to_1c` в таблице `orders` - флаг выгрузки заказа
- Поле `sku` в таблице `products` - артикул товара для идентификации в 1С
- Сохранение цены на момент покупки в `order_items.price_at_purchase`

### 2. Сервис интеграции (`OneCService`)
- **Метод `exportOrder(Order $order)`** - выгружает один заказ в 1С
- **Метод `exportPendingOrders()`** - выгружает все невыгруженные заказы
- **Метод `formatOrderFor1C(Order $order)`** - форматирует данные заказа для 1С

### 3. Автоматическая выгрузка
- При изменении статуса заказа на "Новый" или "В обработке" заказ автоматически выгружается в 1С
- Реализовано в `AdminController::updateOrderStatus()`

### 4. Ручная выгрузка
- **Админ-панель**: `/admin/onec` - страница управления интеграцией
- **Artisan команда**: `php artisan 1c:sync-orders` - синхронизация через командную строку
- **API endpoints**:
  - `POST /admin/onec/export/{order}` - выгрузить конкретный заказ
  - `POST /admin/onec/export-all` - выгрузить все невыгруженные заказы

## Настройка

### 1. Переменные окружения (.env)

```env
# Включить/выключить интеграцию
ONEC_ENABLED=true

# URL сервера 1С (например, http://192.168.1.100:8080)
ONEC_BASE_URL=http://your-1c-server:8080

# Учетные данные для доступа к API 1С
ONEC_USERNAME=your_username
ONEC_PASSWORD=your_password
```

### 2. Формат данных, отправляемых в 1С

```json
{
  "order_id": 123,
  "order_number": "ORD-000123",
  "date": "2025-12-01T15:30:00",
  "status": "Новый",
  "total_amount": 15000.00,
  "payment_method": "Наличные",
  "delivery_method": "Самовывоз",
  "customer": {
    "name": "Иван Иванов",
    "phone": "+7 (999) 123-45-67",
    "email": "ivan@example.com",
    "address": "г. Москва, ул. Примерная, д. 1"
  },
  "items": [
    {
      "sku": "PART-001",
      "name": "Авиационная запчасть",
      "quantity": 2,
      "price": 5000.00,
      "total": 10000.00
    }
  ],
  "comment": "Комментарий к заказу"
}
```

### 3. Требования к API 1С

1С должна предоставлять REST API endpoint:
- **URL**: `{ONEC_BASE_URL}/api/orders`
- **Метод**: `POST`
- **Аутентификация**: Basic Auth (username/password)
- **Content-Type**: `application/json`
- **Ответ при успехе**: HTTP 200/201 с JSON

## Использование

### Через админ-панель

1. Перейдите в раздел "1С" в админ-панели
2. Просмотрите статистику выгруженных заказов
3. Нажмите "Выгрузить все невыгруженные заказы" для массовой выгрузки
4. Или выгрузите конкретный заказ из списка

### Через командную строку

```bash
# Выгрузить все невыгруженные заказы
php artisan 1c:sync-orders

# Выгрузить конкретный заказ
php artisan 1c:sync-orders --order-id=123
```

### Автоматическая выгрузка

Заказы автоматически выгружаются в 1С при:
- Изменении статуса заказа на "Новый" или "В обработке" (если еще не выгружен)
- Создании нового заказа (если интеграция настроена на создание)

## Логирование

Все операции логируются в Laravel log:
- Успешные выгрузки: `storage/logs/laravel.log` с уровнем `info`
- Ошибки: с уровнем `error`

Пример лога:
```
[2025-12-01 15:30:00] local.INFO: Order successfully exported to 1C {"order_id":123}
[2025-12-01 15:30:01] local.ERROR: Failed to export order to 1C {"order_id":124,"status":500}
```

## Маппинг данных

### Статусы заказов
- `new` → `Новый`
- `processing` → `ВОбработке`
- `completed` → `Выполнен`
- `cancelled` → `Отменен`

### Способы оплаты
- `cash` → `Наличные`
- `card` → `БанковскаяКарта`
- `transfer` → `БанковскийПеревод`

### Способы доставки
- `pickup` → `Самовывоз`
- `courier` → `Курьер`
- `transport` → `ТранспортнаяКомпания`

## Обработка ошибок

- При ошибке выгрузки заказ остается с флагом `is_synced_to_1c = false`
- Ошибки логируются, но не прерывают работу системы
- Можно повторить выгрузку вручную через админ-панель или команду

## Планировщик задач (опционально)

Для автоматической периодической синхронизации добавьте в `app/Console/Kernel.php`:

```php
protected function schedule(Schedule $schedule)
{
    // Синхронизация каждые 5 минут
    $schedule->command('1c:sync-orders')
             ->everyFiveMinutes();
}
```

## Безопасность

- Используйте HTTPS для соединения с 1С в продакшене
- Храните учетные данные в `.env`, не коммитьте их в репозиторий
- Используйте сильные пароли для доступа к API 1С
- Ограничьте доступ к админ-панели только для администраторов

## Тестирование

Для тестирования интеграции без реального сервера 1С:

1. Используйте mock-сервер (например, Postman Mock Server)
2. Установите `ONEC_ENABLED=true`
3. Настройте `ONEC_BASE_URL` на адрес mock-сервера
4. Проверьте логи на наличие ошибок

## Поддержка

При возникновении проблем:
1. Проверьте логи: `storage/logs/laravel.log`
2. Убедитесь, что переменные окружения настроены правильно
3. Проверьте доступность сервера 1С
4. Проверьте учетные данные для доступа к API

