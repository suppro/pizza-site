# 2.4. Реализация системы

## 2.4.1. Реализация модуля каталога товаров

Модуль каталога товаров обеспечивает отображение товаров, поиск, фильтрацию и навигацию по категориям (рисунок 2.7).

*[Рисунок 2.7 – Интерфейс каталога товаров с фильтрами и поиском]*

Реализация выполнена с использованием паттерна MVC и оптимизирована для работы с большим количеством товаров [6; 11; 20].

Модуль каталога включает следующие компоненты:

- **Контроллер `CatalogController`** – обрабатывает запросы на отображение каталога товаров с поддержкой поиска и фильтрации.
- **Контроллер `ProductController`** – обрабатывает запросы на отображение детальной информации о товаре.
- **Модель `Product`** – представляет товар в системе, использует Eloquent ORM для взаимодействия с базой данных.
- **Модель `Category`** – представляет категорию товаров с поддержкой иерархической структуры.
- **Модель `ProductImage`** – представляет изображения товаров.

Поиск товаров реализован с использованием SQL-запросов с условиями `LIKE` для поиска по названию, артикулу и описанию (Приложение 2).

### Отображение товаров и категорий

Отображение товаров реализовано через Blade-шаблоны с использованием компонента `product-card.blade.php` для единообразного отображения карточек товаров.

**Структура представления каталога:**

1. **Панель фильтров** – содержит поля поиска, фильтры по категориям, цене, наличию и сортировке
2. **Сетка товаров** – отображает карточки товаров в адаптивной сетке (1-4 колонки в зависимости от размера экрана)
3. **Пагинация** – для навигации по страницам при большом количестве товаров

*[Рисунок 2.10 – Карточка товара в каталоге]*

**Алгоритм получения товаров с учетом иерархии категорий:**

При выборе категории система автоматически включает товары из всех подкатегорий. Это обеспечивается путем рекурсивного получения ID всех дочерних категорий и использования `whereIn` в запросе.

**Оптимизация запросов:**

Для предотвращения проблемы N+1 запросов используется eager loading:

```php
$productsQuery = Product::where('is_active', true)
    ->with('mainImage')
    ->with('category');
```

*[app/Http/Controllers/CatalogController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/CatalogController.php)*

Это позволяет загрузить все необходимые связанные данные одним запросом вместо множества отдельных запросов для каждого товара.

## 2.4.2. Реализация модуля корзины и оформления заказа

Модуль корзины и оформления заказа обеспечивает управление выбранными товарами и процесс создания заказа. Реализация использует сессии Laravel для хранения данных корзины.

### Управление корзиной (сессии)

Корзина хранится в сессии пользователя в виде ассоциативного массива, где ключом является ID товара, а значением – массив с данными товара и количеством.

**Структура данных корзины в сессии:**

```php
$cart = [
    'product_id' => [
        'product' => Product object,
        'quantity' => integer
    ],
    // ...
];
```

*[app/Http/Controllers/CartController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/CartController.php)*

*[Рисунок 2.13 – Интерфейс корзины с товарами]*

**Методы управления корзиной в `CartController`:**

1. `add()` – добавление товара в корзину с проверкой наличия на складе
2. `update()` – обновление количества товара в корзине
3. `remove()` – удаление товара из корзины
4. `clear()` – очистка всей корзины

Алгоритм добавления товара в корзину представлен на рисунке 2.14.

*[Рисунок 2.14 – Алгоритм добавления товара в корзину]*

Ключевой фрагмент кода добавления товара представлен на рисунке 2.15.

*[Рисунок 2.15 – Фрагмент кода метода add() контроллера CartController]*

*[app/Http/Controllers/CartController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/CartController.php)*

### Трехшаговый процесс оформления заказа

Процесс оформления заказа разделен на три последовательных шага для упрощения и снижения количества ошибок. Данные каждого шага сохраняются в сессии и используются на следующих шагах.

**Шаг 1: Данные клиента** (`checkout-step1.blade.php`)

На первом шаге пользователь вводит контактные данные:
- имя;
- телефон;
- email (опционально);
- адрес доставки;
- комментарий к заказу (опционально).

**Шаг 2: Способ доставки и оплаты** (`checkout-step2.blade.php`)

На втором шаге пользователь выбирает:
- способ доставки (самовывоз, курьер, транспортная компания);
- способ оплаты (наличные, карта, банковский перевод);

*[Рисунок 2.17 – Оформление заказа (доставка и оплата)]*

**Шаг 3: Подтверждение заказа** (`checkout-step3.blade.php`)

На третьем шаге отображается сводная информация о заказе для подтверждения:
- данные клиента;
- состав заказа;
- способ доставки и оплаты;
- итоговая сумма.

*[Рисунок 2.18 – Оформление заказа (подтверждение)]*

### Валидация данных

На каждом шаге оформления заказа выполняется валидация данных с использованием встроенных правил валидации Laravel:

**Валидация шага 1:**

```php
$request->validate([
    'customer_name' => 'required|string|max:255',
    'customer_phone' => 'required|string|max:20',
    'customer_email' => 'nullable|email|max:255',
]);
```

*[app/Http/Controllers/OrderController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/OrderController.php)*

**Валидация шага 2:**

```php
$request->validate([
    'delivery_address' => 'required|string|max:500',
    'delivery_method' => 'required|in:pickup,courier,transport',
    'payment_method' => 'required|in:cash,card,transfer',
    'comment' => 'nullable|string|max:1000',
]);
```

*[app/Http/Controllers/OrderController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/OrderController.php)*

При ошибках валидации пользователь возвращается на предыдущий шаг с отображением сообщений об ошибках.

Личный кабинет клиента реализован через метод `index()` контроллера `OrderController`, который отображает историю заказов пользователя.

**Функциональность личного кабинета:**

- просмотр списка всех заказов пользователя;
- фильтрация заказов по статусу;
- просмотр детальной информации о заказе;
- отслеживание статуса заказа.

*[Рисунок 2.19 – Мои заказы]*

**Код получения заказов пользователя:**

```php
public function index()
{
    if (!auth()->check()) {
        return redirect()->route('login');
    }

    $orders = Order::where('user_id', auth()->id())
                  ->with('items')
                  ->orderBy('created_at', 'desc')
                  ->get();

    return view('orders', compact('orders'));
}
```

*[app/Http/Controllers/OrderController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/OrderController.php)*

## 2.4.3. Реализация модуля управления заказами

Модуль управления заказами обеспечивает обработку заказов администраторами, изменение статусов, отправку уведомлений и интеграцию с системой 1С.

*[Рисунок 2.20 – Управление заказами в административной панели]*

Система поддерживает четыре статуса заказов:

- `new` – новый заказ, требует обработки;
- `processing` – заказ в обработке;
- `completed` – заказ выполнен;
- `cancelled` – заказ отменен.

Статусы хранятся в виде ENUM в базе данных, что обеспечивает валидацию на уровне БД.

Интеграция с системой 1С реализована через сервисный класс `OneCService`, который инкапсулирует всю логику взаимодействия с API 1С.

**Автоматическая выгрузка заказов:**

При изменении статуса заказа на "new" или "processing" автоматически запускается процесс выгрузки заказа в 1С (если интеграция включена и заказ еще не был выгружен):

```php
if (in_array($newStatus, ['new', 'processing']) && 
    !$order->is_synced_to_1c && 
    config('services.onec.enabled')) {
    
    $oneCService = new OneCService();
    try {
        $oneCService->exportOrder($order);
        $order->update(['is_synced_to_1c' => true]);
    } catch (\Exception $e) {
        \Log::error("Ошибка выгрузки заказа #{$order->id} в 1С: " . $e->getMessage());
    }
}
```

*[app/Http/Controllers/Admin/AdminController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/Admin/AdminController.php)*

### Описание алгоритма выгрузки заказов

Алгоритм выгрузки заказа в систему 1С представлен на рисунке 2.21.

*[Рисунок 2.21 – Алгоритм выгрузки заказа в систему 1С]*

Метод форматирования данных для 1С представлен на рисунке 2.22.

*[Рисунок 2.22 – Фрагмент кода метода formatOrderFor1C()]*

*[app/Services/OneCService.php](https://github.com/your-username/pizza-site/blob/main/app/Services/OneCService.php)*

Скриншот интеграции с 1С приведен на рисунке 2.23.

*[Рисунок 2.23 – Управление интеграцией с 1С в административной панели]*

## 2.4.4. Реализация административной панели

Административная панель обеспечивает полное управление системой интернет-магазина через веб-интерфейс. Все функции доступны только пользователям с ролью "admin".

Управление товарами реализовано через ресурсный контроллер `ProductController` в пространстве имен `Admin`.

**Список товаров** (`index()`):

- отображение таблицы товаров с пагинацией;
- поиск по названию и артикулу;
- фильтрация по категории и активности;
- ссылки на создание, редактирование и удаление товаров.

*[Рисунок 2.24 – Страница списка товаров в административной панели]*

**Создание товара** (`create()`, `store()`):

- Форма с полями: название, категория, артикул, описание, цена, остаток, статус
- Загрузка нескольких изображений
- Редактор технических характеристик (JSON)
- Валидация уникальности артикула

*[Рисунок 2.25 – Скриншот формы создания товара]*

**Редактирование товара** (`edit()`, `update()`):

- аналогичная форма с предзаполненными данными;
- управление изображениями (добавление, удаление, установка главного);
- обновление всех полей товара.

*[Рисунок 2.26 – Форма редактирования товара]*

**Удаление товара** (`destroy()`) использует мягкое удаление через установку `is_active = false` или полное удаление, и осуществляет проверку связанных заказов перед удалением.

Управление категориями реализовано через ресурсный контроллер `CategoryController` с поддержкой иерархической структуры.

*[Рисунок 2.27 – Страница управления категориями с иерархической структурой]*

Управление заказами реализовано в контроллере `AdminController` и позволяет осуществлять просмотр списка заказов с фильтрацией и поиском, просмотр детальной информации о заказе, изменение статуса заказа и ручную выгрузку заказа в 1С.

*[Рисунок 2.28 – Страница детального просмотра заказа]*

Управление пользователями реализовано через ресурсный контроллер `UserController` и позволяет выполнять просмотр списка пользователей, создавать новых пользователей, редактирование данных пользователей (имя, email, телефон, роль), удаление пользователей (с защитой от удаления текущего администратора).

*[Рисунок 2.29 – Страница управления пользователями]*

**Защита от удаления текущего администратора:**

```php
public function destroy($id)
{
    $user = auth()->user();
    if ($user->id == $id) {
        return back()->with('error', 'Вы не можете удалить свой собственный аккаунт');
    }

    User::findOrFail($id)->delete();
    return back()->with('success', 'Пользователь успешно удален');
}
```

*[app/Http/Controllers/Admin/UserController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/Admin/UserController.php)*

Дашборд административной панели отображает основную статистику по общему количеству заказов, количеству новых заказов, активных заказов (в обработке), общему количеству пользователей и списку последних заказов.

*[Рисунок 2.30 – Дашборд административной панели со статистикой]*

**Код получения статистики:**

```php
public function dashboard()
{
    $stats = [
        'total_orders' => Order::count(),
        'new_orders' => Order::where('status', 'new')->count(),
        'active_orders' => Order::whereIn('status', ['new', 'processing'])->count(),
        'total_users' => User::count()
    ];

    $recent_orders = Order::with(['user', 'items'])
                        ->orderBy('created_at', 'desc')
                        ->take(5)
                        ->get();

    return view('admin.dashboard', compact('stats', 'recent_orders'));
}
```

*[app/Http/Controllers/Admin/AdminController.php](https://github.com/your-username/pizza-site/blob/main/app/Http/Controllers/Admin/AdminController.php)*

## 2.4.5. Реализация интеграции с 1С:Предприятие

Интеграция с системой 1С:Предприятие реализована через сервисный класс `OneCService`, который инкапсулирует всю логику взаимодействия с REST API системы 1С.

### Сервис интеграции (OneCService)

Класс `OneCService` обеспечивает выгрузку заказов в систему 1С, форматирование данных заказов для API 1С, обработку ответов от системы 1С, логирование операций интеграции.

**Конструктор класса:**

```php
public function __construct()
{
    $this->baseUrl = config('services.onec.base_url');
    $this->username = config('services.onec.username');
    $this->password = config('services.onec.password');
    $this->enabled = config('services.onec.enabled', false);
}
```

*[app/Services/OneCService.php](https://github.com/your-username/pizza-site/blob/main/app/Services/OneCService.php)*

### Форматирование данных для 1С

Метод `formatOrderFor1C()` преобразует данные заказа из формата базы данных в формат, ожидаемый API системы 1С.

### Обработка ответов от 1С

Система обрабатывает различные типы ответов от API 1С:

- успешный ответ (HTTP 200-299): заказ помечается как синхронизированный (`is_synced_to_1c = true`);
- ошибка клиента (HTTP 400-499): логируется ошибка, заказ остается несинхронизированным;
- ошибка сервера (HTTP 500-599): логируется ошибка, возможна повторная попытка;
- исключения (таймаут, сетевые ошибки): логируются, заказ остается несинхронизированным.

Все ошибки логируются в файл `storage/logs/laravel.log` с детальной информацией для последующего анализа.

В административной панели реализован интерфейс управления интеграцией с 1С (`/admin/onec`), который позволяет осуществить просмотр статуса интеграции (включена/выключена), статистики синхронизации, списка невыгруженных заказов.

Реализация системы выполнена с использованием современных подходов разработки веб-приложений на Laravel. Модульная архитектура обеспечивает разделение ответственности между компонентами, что упрощает сопровождение и расширение системы.

Использование сессий для хранения корзины обеспечивает простоту реализации и хорошую производительность. Трехшаговый процесс оформления заказа снижает количество ошибок и повышает удобство использования. Интеграция с системой 1С реализована через сервисный класс, что обеспечивает инкапсуляцию логики и возможность легкого тестирования. Автоматическая выгрузка заказов при изменении статуса и возможность ручной выгрузки обеспечивают гибкость в работе с системой учета. Административная панель предоставляет полный набор инструментов для управления системой, включая CRUD-операции для всех основных сущностей, управление заказами и интеграцию с внешними системами.
